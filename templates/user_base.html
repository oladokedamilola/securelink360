<!-- Base template for authenticated users with responsive sidebar navigation -->
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}{% endblock %} | SecureLink 360</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}">

<style>
  :root{
    /* responsive sidebar width: clamps between min and max while remaining responsive */
    --sidebar-min: 220px;
    --sidebar-max: 300px;
    --sidebar-width: clamp(var(--sidebar-min), 27%, var(--sidebar-max));
  }

  /* reset any browser default body margin that could add gaps */
  body {
    margin: 0;
  }

  .form-errors {
    color: #dc3545;
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 1rem;
    padding: 0.75rem 1rem;
    border: 1px solid #f5c2c7;
    background-color: #f8d7da;
    border-radius: 0.5rem;
  }

  /* Flash message overrides */
  .alert-error { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
  .alert-success { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
  .alert-warning { background-color: #fff3cd; color: #664d03; border: 1px solid #ffecb5; }
  .alert-info { background-color: #cff4fc; color: #055160; border: 1px solid #b6effb; }

  /* Sidebar base: use the CSS var so main-content can reference the exact same width */
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: var(--sidebar-width);
    max-width: var(--sidebar-max);
    min-width: var(--sidebar-min);
    background-color: #121212;
    color: #fff;
    overflow-y: auto;
    transition: transform 0.3s ease-in-out;
    z-index: 1050;
    box-sizing: border-box;
  }

  @media (min-width: 992px) {
    .sidebar { transform: translateX(0); }
    /* align main content exactly to the right edge of the sidebar */
    .main-content { margin-left: var(--sidebar-width); }
    #mobileMenuToggler { display: none; }
  }

  @media (max-width: 991px) {
    .sidebar {
      width: 70%;
      max-width: 300px;
      transform: translateX(-100%);
    }
    .sidebar.mobile-visible { transform: translateX(0); }
    .main-content { margin-left: 0; }
    #mobileMenuToggler {
      display: block;
      margin: 1rem;
      position: fixed;
      z-index: 1060;
    }
  }

  .sidebar-close { cursor: pointer; }
  .nav-link.active {
    background-color: #00BCD4;
    color: #fff !important;
  }
  .nav-link {
    color: #ccc;
    transition: background-color 0.2s;
  }
  .nav-link:hover {
    background-color: #1f1f1f;
    color: #fff;
  }

  /* --- OVERRIDE style.css to keep sidebar + content aligned --- */
@media (min-width: 992px) {
  #sidebar {
    width: clamp(220px, 27%, 300px) !important; /* same as .sidebar */
  }
  .main-content {
    margin-left: clamp(220px, 27%, 300px) !important;
  }
}
/* --- END OVERRIDE --- */
/* Mobile Hamburger Button */
.mobile-toggler {
  position: fixed;
  top: 1rem;
  left: 1rem;
  z-index: 1060;
  background-color: #fff;
  border: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  width: 3rem;
  height: 3rem;
  display: flex;
  align-items: center;
  justify-content: center;
}
.mobile-toggler:hover {
  background-color: #f0f0f0;
}
.mobile-toggler:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(0,123,255,0.5);
}
/* Logout link hover */
.logout-link:hover {
  background-color: #ffe5e5;
  color: #dc3545 !important;
  text-decoration: none;
}
</style>


  {% block extra_css %}{% endblock %}
</head>

<body class="light-mode">
<!-- Toast container for flash messages -->
<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>

  <!-- Mobile Hamburger -->
  <button class="mobile-toggler d-lg-none btn btn-outline-primary rounded-circle shadow-sm"
          id="mobileMenuToggler" aria-label="Open Sidebar">
    <i class="fas fa-bars fs-4"></i>
  </button>

  <div class="wrapper d-flex">
    <!-- Sidebar -->
<aside class="sidebar ps-3" id="sidebar">
    <div class="sidebar-header p-3 d-flex align-items-center justify-content-between border-bottom">
        <a href="{% url 'home' %}" class="d-flex align-items-center text-decoration-none">
            <img src="{% static 'images/fav-icon.png' %}" alt="SecureLink 360" width="32" height="32" style="border-radius:6px;">
            <span class="ms-2 fw-bold" style="color:#00BCD4;">SecureLink 360</span>
        </a>
        <button class="sidebar-close d-lg-none btn btn-sm text-muted" id="sidebarCloseBtn" aria-label="Close Sidebar">
            <i class="fas fa-times fs-5"></i>
        </button>
    </div>

    <nav class="sidebar-nav d-flex flex-column h-100">
        <ul class="nav flex-column px-3 py-3">
            {% if user.is_authenticated %}
                {# --- COMMON DASHBOARD LINK --- #}
                {% if user.is_company_admin %}
                    <li class="nav-item">
                        <a href="{% url 'admin_dashboard' %}" class="nav-link py-2 px-2 rounded {% if request.resolver_match.url_name == 'admin_dashboard' %}active{% endif %}">
                            <i class="fas fa-user-circle me-2"></i> Admin Dashboard
                        </a>
                    </li>
                {% elif user.role == "manager" %}
                    <li class="nav-item">
                        <a href="{% url 'manager_dashboard' %}" class="nav-link py-2 px-2 rounded {% if request.resolver_match.url_name == 'manager_dashboard' %}active{% endif %}">
                            <i class="fas fa-user-circle me-2"></i> Manager Dashboard
                        </a>
                    </li>
                {% else %}
                    <li class="nav-item">
                        <a href="{% url 'employee_dashboard' %}" class="nav-link py-2 px-2 rounded {% if request.resolver_match.url_name == 'employee_dashboard' %}active{% endif %}">
                            <i class="fas fa-user-circle me-2"></i> Employee Dashboard
                        </a>
                    </li>
                {% endif %}

                {# --- COMPANY ADMIN LINKS --- #}
                {% if user.is_company_admin %}
                    <li class="nav-header mt-2 mb-1 text-uppercase small text-muted">Admin Pages</li>
                    <li class="nav-item"><a href="{% url 'company_profile' %}" class="nav-link py-2 px-2 rounded"><i class="fas fa-building me-2"></i> Company Profile</a></li>
                    <li class="nav-item"><a href="{% url 'announcements_list' %}" class="nav-link py-2 px-2 rounded"><i class="fas fa-bullhorn me-2"></i> Announcements</a></li>
                    <li class="nav-item"><a href="{% url 'admin_devices' %}" class="nav-link py-2 px-2 rounded"><i class="fas fa-desktop me-2"></i> Devices</a></li>
                    <li class="nav-item"><a href="{% url 'user_management' %}" class="nav-link py-2 px-2 rounded"><i class="fas fa-users me-2"></i> Users</a></li>
                    <li class="nav-item"><a href="{% url 'send_invite' %}" class="nav-link py-2 px-2 rounded"><i class="fas fa-user-plus me-2"></i> Invite Team</a></li>
                    <li class="nav-item"><a href="{% url 'admin_company_networks' %}" class="nav-link py-2 px-2 rounded"><i class="fas fa-network-wired me-2"></i> Network Management</a></li>
                    
                    {# --- LIVE NETWORK MONITORING --- #}
                    <li class="nav-item">
                        <a href="{% url 'live_networks_list' %}" 
                          class="nav-link py-2 px-2 rounded {% if 'live_networks_list' in request.resolver_match.url_name %}active{% endif %}">
                            <i class="fas fa-broadcast-tower me-2"></i> Live Network Monitor
                        </a>
                    </li>

                    
                    {# --- JOIN REQUESTS & SECURITY --- #}
                    <li class="nav-item">
                        <a href="{% url 'admin_join_requests' %}" class="nav-link py-2 px-2 rounded {% if 'admin_join_requests' in request.resolver_match.url_name %}active{% endif %}">
                            <i class="fas fa-user-clock me-2"></i> Join Requests
                            {% if join_requests_count > 0 %}
                                <span class="badge bg-warning float-end">{{ join_requests_count }}</span>
                            {% endif %}
                        </a>
                    </li>
                    <li class="nav-item"><a href="{% url 'admin_unauthorized_attempts' %}" class="nav-link py-2 px-2 rounded"><i class="fas fa-exclamation-triangle me-2"></i> Unauthorized Attempts</a></li>
                {% endif %}

                {# --- MANAGER LINKS --- #}
                {% if user.role == "manager" %}
                    <li class="nav-header mt-2 mb-1 text-uppercase small text-muted">Team Pages</li>
                    <li class="nav-item"><a href="{% url 'manager_team_overview' %}" class="nav-link py-2 px-2 rounded"><i class="fas fa-users me-2"></i> Team Overview</a></li>
                    <li class="nav-item"><a href="{% url 'manager_team_devices' %}" class="nav-link py-2 px-2 rounded"><i class="fas fa-desktop me-2"></i> Devices</a></li>
                    <li class="nav-item"><a href="{% url 'manager_team_alerts' %}" class="nav-link py-2 px-2 rounded"><i class="fas fa-exclamation-triangle me-2"></i> Alerts</a></li>
                    <li class="nav-item"><a href="{% url 'manager_team_announcements' %}" class="nav-link py-2 px-2 rounded"><i class="fas fa-bullhorn me-2"></i> Announcements</a></li>
                    
                    {# --- LIVE NETWORK ACCESS FOR MANAGERS --- #}
                    <li class="nav-header mt-3 mb-1 text-uppercase small text-muted">Network Access</li>
                    <li class="nav-item">
                        <a href="{% url 'live_networks_list' %}" class="nav-link py-2 px-2 rounded {% if 'live_networks_list' in request.resolver_match.url_name %}active{% endif %}">
                            <i class="fas fa-wifi me-2"></i> Available Networks
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'employee_my_networks' %}" class="nav-link py-2 px-2 rounded {% if 'employee_my_networks' in request.resolver_match.url_name %}active{% endif %}">
                            <i class="fas fa-layer-group me-2"></i> My Networks
                        </a>
                    </li>
                {% endif %}

                {# --- EMPLOYEE LINKS --- #}
                {% if user.role == "employee" %}
                    <!-- My Tasks -->
                    <li class="nav-item">
                        <a href="{% url 'employee_tasks' %}" class="nav-link py-2 px-2 rounded {% if 'employee_tasks' in request.resolver_match.url_name %}active{% endif %}">
                            <i class="fas fa-tasks me-2"></i> My Tasks
                        </a>
                    </li>

                    <!-- Announcements -->
                    <li class="nav-item">
                        <a href="{% url 'announcements_list' %}" class="nav-link py-2 px-2 rounded {% if 'announcements_list' in request.resolver_match.url_name %}active{% endif %}">
                            <i class="fas fa-newspaper me-2"></i> Announcements
                        </a>
                    </li>

                    <!-- Network Access -->
                    <li class="nav-header mt-2 mb-1 text-uppercase small text-muted">Network Access</li>
                    
                    <li class="nav-item">
                        <a href="{% url 'live_networks_list' %}" class="nav-link py-2 px-2 rounded {% if 'live_networks_list' in request.resolver_match.url_name %}active{% endif %}">
                            <i class="fas fa-wifi me-2"></i> Join Networks
                        </a>
                    </li>

                    <li class="nav-item">
                        <a href="{% url 'employee_my_networks' %}" class="nav-link py-2 px-2 rounded {% if 'employee_my_networks' in request.resolver_match.url_name %}active{% endif %}">
                            <i class="fas fa-layer-group me-2"></i> My Networks
                        </a>
                    </li>

                    <li class="nav-item">
                        <a href="{% url 'employee_join_requests' %}" class="nav-link py-2 px-2 rounded {% if 'employee_join_requests' in request.resolver_match.url_name %}active{% endif %}">
                            <i class="fas fa-history me-2"></i> My Join Requests
                        </a>
                    </li>

                    <!-- My Devices -->
                    <li class="nav-item">
                        <a href="{% url 'my_devices' %}" class="nav-link py-2 px-2 rounded {% if 'my_devices' in request.resolver_match.url_name %}active{% endif %}">
                            <i class="fas fa-desktop me-2"></i> My Devices
                        </a>
                    </li>

                {% endif %}

                {# --- COMMON LINKS FOR ALL ROLES --- #}
                <li class="nav-item mt-3">
                    <a href="{% url 'my_notifications' %}" class="nav-link py-2 px-2 rounded position-relative">
                        <i class="fas fa-bell me-2"></i> Notifications
                        {% if notifications_unread_count > 0 %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size:0.6rem;">
                                {{ notifications_unread_count }}
                            </span>
                        {% endif %}
                    </a>
                </li>

                <li class="nav-item mt-4">
                    <a href="{% url 'logout' %}" class="nav-link text-danger py-2 px-2 rounded logout-link">
                        <i class="fas fa-sign-out-alt me-2"></i> Logout
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
</aside>

    <!-- Main Content -->
    <div class="main-content ps-3 mt-3 flex-grow-1" id="mainContent">
      {% block flash %}
        {% if messages %}
          <div class="position-fixed top-0 start-50 translate-middle-x mt-3"
               style="z-index:1055; width:auto; max-width:90%;">
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow"
                   role="alert" style="min-width:300px;">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endblock flash %}

      {% block content %}{% endblock %}
    </div>
  </div>

  <!-- Profile Edit Modal -->
  <div class="modal fade" id="editProfileModal" tabindex="-1"
       aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg border-0 rounded-3">
        <form method="post" enctype="multipart/form-data" action="{% url 'edit_profile' %}">
          {% csrf_token %}
          <div class="modal-header bg-light border-0">
            <h5 class="modal-title fw-semibold" id="editProfileModalLabel">
              <i class="fas fa-user-edit me-2 text-primary"></i> Edit Profile
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <!-- First & Last Name fields -->
            <div class="mb-3">
              {{ profile_edit_form.first_name.label_tag }}
              {{ profile_edit_form.first_name }}
            </div>
            <div class="mb-3">
              {{ profile_edit_form.last_name.label_tag }}
              {{ profile_edit_form.last_name }}
            </div>

            <!-- Email (read-only) -->
            <div class="mb-3">
              <label class="form-label">Email (cannot be changed)</label>
              <input type="email" class="form-control" value="{{ user.email }}" disabled>
            </div>

            <!-- Profile Image with preview -->
            <div class="mb-3 text-center">
              {% if user.profile_image %}
                <img id="profileImagePreview" src="{{ user.profile_image.url }}"
                     alt="Profile" class="rounded-circle border mb-3 shadow-sm" width="100" height="100">
              {% else %}
                <img id="profileImagePreview" src="{% static 'images/default-avatar.png' %}"
                     alt="Profile" class="rounded-circle border mb-3 shadow-sm" width="100" height="100">
              {% endif %}
              <div>
                <input type="file" name="profile_image" class="form-control" id="id_profile_image">
                <small class="text-muted d-block mt-1">Choose a new profile picture (optional)</small>
              </div>
            </div>
          </div>

          <div class="modal-footer border-0">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-1"></i> Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
document.addEventListener("DOMContentLoaded", function() {
  const alertsPanel = document.getElementById("alerts-panel");
  const badge = document.getElementById("alerts-badge");

  if (alertsPanel && badge) {
    alertsPanel.addEventListener("click", function() {
      // Hide badge immediately
      badge.textContent = "";
      badge.classList.add("d-none");

      // Notify backend to mark as read
      fetch("/alerts/mark-read/", {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"), // if CSRF enabled
          "Content-Type": "application/json"
        },
        body: JSON.stringify({})
      })
      .then(res => res.json())
      .then(data => console.log("Alerts marked read:", data))
      .catch(err => console.error("Error marking alerts read:", err));
    });
  }

  // Helper to grab CSRF token if Django CSRF is enabled
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>

  {% comment %}
  <!-- Change Password Modal -->
  <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" action="{% url 'change_password' %}">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="changePasswordModalLabel">Change Password</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            {{ password_change_form.as_p }}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update Password</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endcomment %}

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const toggler = document.getElementById('mobileMenuToggler');
      const sidebar = document.getElementById('sidebar');
      const closeBtn = document.getElementById('sidebarCloseBtn');

      if (toggler && closeBtn) {
        toggler.addEventListener('click', () => {
          sidebar.classList.add('mobile-visible');
          toggler.style.display = 'none';
        });
        closeBtn.addEventListener('click', () => {
          sidebar.classList.remove('mobile-visible');
          toggler.style.display = 'block';
        });
      }

      setTimeout(() => {
        document.querySelectorAll('.alert').forEach(a => bootstrap.Alert.getOrCreateInstance(a).close());
      }, 7000);

      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(el => new bootstrap.Tooltip(el));

      const imageInput = document.getElementById("id_profile_image");
      const preview = document.getElementById("profileImagePreview");
      if (imageInput) {
        imageInput.addEventListener("change", function () {
          const file = this.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = e => preview.src = e.target.result;
            reader.readAsDataURL(file);
          }
        });
      }
    });
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>
